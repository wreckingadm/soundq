<!DOCTYPE html>
<html>
<head>
   <title>SoundQ-JS - Queued audio playback with priority and channel support for the web.</title>

   <meta charset="UTF-8">

   <link rel="stylesheet" type="text/css" href="reset.css">
   <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
   <link rel="stylesheet" type="text/css" href="soundq.css">
</head>

<body>
   <!-- Quick button test for now -->
   <a id="audio_play" class="button">Play Audio</a>
   <audio id="audio_demo" preload="none">
      <source src="http://playground.wreckreation.org.s3-website-us-east-1.amazonaws.com/soundq-js/test/rl_short.m4a" type="audio/mp4">
      <source src="http://playground.wreckreation.org.s3-website-us-east-1.amazonaws.com/soundq-js/test/rl_short.ogg" type="audio/ogg">
   </audio>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<script>
//http://matt-harrison.com/perfect-web-audio-on-ios-devices-with-the-web-audio-api/
try {
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    window.audioContext = new window.AudioContext();
    console.log("We have Web Audio API support");
} catch (e) {
    console.log("No Web Audio API support");
}

/*
 * WebAudioAPISoundManager Constructor
 */
 var WebAudioAPISoundManager = function (context) {
    this.context = context;
    this.bufferList = {};
    this.playingSounds = {};
};

/*
 * WebAudioAPISoundManager Prototype
 */
WebAudioAPISoundManager.prototype = {
     addSound: function (url) {
        // Load buffer asynchronously
        var request = new XMLHttpRequest();
        request.open("GET", url, true);
        request.responseType = "arraybuffer";

        var self = this;

        request.onload = function () {
             console.log("Loaded " + url);
            // Asynchronously decode the audio file data in request.response
            self.context.decodeAudioData(
                request.response,

                function (buffer) {
                    if (!buffer) {
                        alert('error decoding file data: ' + url);
                        return;
                    }
                    self.bufferList[url] = buffer;
                });
        };

        request.onerror = function () {
            alert('BufferLoader: XHR error');
        };

        request.send();
    },
    stopSoundWithUrl: function(url) {
        if(this.playingSounds.hasOwnProperty(url)){
            for(var i in this.playingSounds[url]){
                if(this.playingSounds[url].hasOwnProperty(i))
                    this.playingSounds[url][i].noteOff(0);
            }
        }
    }
};

/*
 * WebAudioAPISound Constructor
 */
 var WebAudioAPISound = function (url, options) {
    this.settings = {
        loop: false
    };

    for(var i in options){
        if(options.hasOwnProperty(i))
            this.settings[i] = options[i];
    }

    this.url = url;
    window.webAudioAPISoundManager = window.webAudioAPISoundManager || new WebAudioAPISoundManager(window.audioContext);
    this.manager = window.webAudioAPISoundManager;
    console.log("Adding sound " + this.url);
    this.manager.addSound(this.url);
};

/*
 * WebAudioAPISound Prototype
 */
WebAudioAPISound.prototype = {
    play: function () {
        var buffer = this.manager.bufferList[this.url];
        //Only play if it's loaded yet
        console.log("Thinking about playing");
        if (typeof buffer !== "undefined") {
            var source = this.makeSource(buffer);
            source.loop = this.settings.loop;
            //source.noteOn(0);
            source.start();
            console.log("Playing");

            if(!this.manager.playingSounds.hasOwnProperty(this.url))
                this.manager.playingSounds[this.url] = [];
            this.manager.playingSounds[this.url].push(source);
        }
    },
    stop: function () {
        this.manager.stopSoundWithUrl(this.url);
    },
    getVolume: function () {
        return this.translateVolume(this.volume, true);
    },
    //Expect to receive in range 0-100
    setVolume: function (volume) {
        this.volume = this.translateVolume(volume);
    },
    translateVolume: function(volume, inverse){
        return inverse ? volume * 100 : volume / 100;
    },
    makeSource: function (buffer) {
        var source = this.manager.context.createBufferSource();
        //var gainNode = this.manager.context.createGainNode();
        //gainNode.gain.value = this.volume;
        source.buffer = buffer;
        source.connect(this.manager.context.destination);//gainNode);
        //gainNode.connect(this.manager.context.destination);
        return source;
    }
};




var blastSound, backgroundMusic;

blastSound = new WebAudioAPISound("http://playground.wreckreation.org.s3-website-us-east-1.amazonaws.com/soundq-js/test/rl_short.m4a");
//backgroundMusic = new WebAudioAPISound("smooth-jazz.mp3", {loop: true});

//backgroundMusic.play();
//blastSound.play();
$( '#audio_play' ).text( 'Play Web Audio Sound' );
$( '#audio_play' ).click( function() {
   console.log( "Playing Web Audio sound." );
   $( '#audio_play' ).text( 'Playing Web Audio Sound' );
   blastSound.play();
});

//Play background music for 30 seconds
/*
setTimeout(function(){
    backgroundMusic.stop();
}, 30 * 1000);
*/

$(document).on("click", "a", function(event) {
 event.preventDefault();
 /*
 var dataUrl = $(this).attr("href");
 if (dataUrl != "") {
   loadPage(dataUrl);
 }
 */
});
</script

</body>

</html>
